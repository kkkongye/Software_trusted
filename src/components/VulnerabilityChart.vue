<template>
  <div class="vulnerability-chart">
    <div v-if="hasData" id="vulnerability-chart"></div>
    <div v-else class="empty-state">
      <p>暂无漏洞分析数据，请先进行漏洞扫描。</p>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, watch, onUnmounted, computed } from 'vue';
import * as echarts from 'echarts/core';
import { BarChart } from 'echarts/charts';
import {
  TitleComponent,
  TooltipComponent,
  LegendComponent,
  GridComponent
} from 'echarts/components';
import { CanvasRenderer } from 'echarts/renderers';

// 定义props
const props = defineProps({
  data: {
    type: Object,
    default: () => ({
      critical: 0,
      high: 0,
      medium: 0,
      low: 0,
      unknown: 0
    })
  }
});

// 注册必要的组件
echarts.use([
  BarChart,
  TitleComponent,
  TooltipComponent,
  LegendComponent,
  GridComponent,
  CanvasRenderer
]);

// 声明响应式数据
const chartData = ref({
  critical: 0,
  high: 0,
  medium: 0,
  low: 0,
  unknown: 0
});
const chartInstance = ref(null);
const vulnReportGenerated = ref(false); // 新增标志，标记是否已经生成漏洞报告

// 检查props中是否有数据
const propsHasData = computed(() => {
  return props.data && Object.values(props.data).some(val => val > 0);
});

// 计算是否有数据要显示
const hasData = computed(() => {
  // 首先判断是否标记为已生成报告
  if (!vulnReportGenerated.value) {
    return false;
  }
  
  // 然后判断是否有实际数据
  const hasChartData = Object.values(chartData.value).some(val => val > 0);
  const hasPropsData = Object.values(props.data).some(val => val > 0);
  
  return hasChartData || hasPropsData;
});

// 初始化图表
const initChart = () => {
  if (chartInstance.value) return;
  
  // 检查是否有props数据或chartData中的数据
  const hasChartData = Object.values(chartData.value).some(val => val > 0);
  const hasPropsData = Object.values(props.data).some(val => val > 0);
  
  if (!hasChartData && !hasPropsData) return; // 如果没有任何数据，不初始化图表
  
  const chartDom = document.getElementById('vulnerability-chart');
  if (!chartDom) return;
  
  chartInstance.value = echarts.init(chartDom);
  updateChart();
  
  // 监听窗口大小变化，更新图表大小
  window.addEventListener('resize', () => {
    chartInstance.value && chartInstance.value.resize();
  });
};

// 更新图表
const updateChart = () => {
  if (!chartInstance.value) return;
  
  // 优先使用props数据
  const useData = Object.values(props.data).some(val => val > 0) ? props.data : chartData.value;
  
  const option = {
    title: {
      text: '漏洞严重程度分布',
      left: 'center'
    },
    tooltip: {
      trigger: 'item',
      formatter: '{b}: {c}个'
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: [
      {
        type: 'category',
        data: ['极其严重', '高危', '中危', '低危', '未知'],
        axisTick: {
          alignWithLabel: true
        }
      }
    ],
    yAxis: [
      {
        type: 'value',
        minInterval: 1
      }
    ],
    series: [
      {
        name: '漏洞数量',
        type: 'bar',
        barWidth: '60%',
        data: [
          { 
            name: '极其严重',
            value: useData.critical, 
            itemStyle: { color: '#ff0000' }
          },
          { 
            name: '高危',
            value: useData.high, 
            itemStyle: { color: '#ff4500' }
          },
          { 
            name: '中危',
            value: useData.medium, 
            itemStyle: { color: '#ffa500' }
          },
          { 
            name: '低危',
            value: useData.low, 
            itemStyle: { color: '#ffff00' }
          },
          { 
            name: '未知',
            value: useData.unknown, 
            itemStyle: { color: '#808080' }
          }
        ]
      }
    ]
  };
  
  chartInstance.value.setOption(option);
};

// 监听props变化
watch(() => props.data, (newData) => {
  if (newData && Object.values(newData).some(val => val > 0)) {
    chartData.value = { ...newData };
    vulnReportGenerated.value = true;
    
    // 如果有数据，初始化或更新图表
    if (!chartInstance.value) {
      initChart();
    } else {
      updateChart();
    }
  }
}, { deep: true, immediate: true });

onMounted(() => {
  // 默认设置为未生成漏洞报告
  vulnReportGenerated.value = false;
  
  // 延迟初始化，确保页面刷新后状态已正确设置
  setTimeout(() => {
    // 检查是否已生成漏洞报告
    const reportGenerated = localStorage.getItem('vulnReportGenerated') === 'true';
    
    // 检查是否真的有数据
    const savedSettings = localStorage.getItem('vulnerabilitySettings');
    const hasRealData = savedSettings && Object.values(JSON.parse(savedSettings || '{}')).some(val => val > 0);
    
    // 只有在有标志和实际数据时才设置为true
    if (reportGenerated && hasRealData) {
      vulnReportGenerated.value = true;
      fetchVulnerabilityData();
    } else {
      // 否则强制设置为false
      vulnReportGenerated.value = false;
      localStorage.setItem('vulnReportGenerated', 'false');
    }
    
    window.addEventListener('storage', handleStorageChange);
  }, 100);
  
  // 定期刷新数据
  const refreshInterval = setInterval(() => {
    fetchVulnerabilityData();
  }, 10000); // 每10秒刷新一次
  
  // 在组件卸载时清除计时器和事件监听
  onUnmounted(() => {
    clearInterval(refreshInterval);
    window.removeEventListener('resize', () => {
      chartInstance.value && chartInstance.value.resize();
    });
    window.removeEventListener('storage', handleStorageChange);
    
    // 释放图表实例
    if (chartInstance.value) {
      chartInstance.value.dispose();
      chartInstance.value = null;
    }
  });
});

// 监听数据变化，更新图表
watch(chartData, () => {
  if (hasData.value) {
    if (!chartInstance.value) {
      initChart();
    } else {
      updateChart();
    }
  } else if (chartInstance.value) {
    // 如果没有数据但图表存在，销毁图表
    chartInstance.value.dispose();
    chartInstance.value = null;
  }
}, { deep: true });

// 获取漏洞数据
const fetchVulnerabilityData = async () => {
  try {
    // 检查是否已生成报告
    const reportGenerated = localStorage.getItem('vulnReportGenerated') === 'true';
    
    // 如果标志为false，直接返回
    if (!reportGenerated) {
      vulnReportGenerated.value = false;
      return; // 如果没有生成报告，不尝试获取数据
    }
    
    // 首先尝试从后端API获取数据
    try {
      const response = await fetch('http://127.0.0.1:5000/vulnerabilities');
      if (response.ok) {
        const data = await response.json();
        if (data.severity_summary) {
          // 检查是否有实际的非零数据
          const hasNonZeroValues = Object.values(data.severity_summary).some(val => val > 0);
          
          if (!hasNonZeroValues) {
            vulnReportGenerated.value = false;
            localStorage.setItem('vulnReportGenerated', 'false');
            return;
          }
          
          chartData.value = {
            critical: data.severity_summary.CRITICAL || 0,
            high: data.severity_summary.HIGH || 0,
            medium: data.severity_summary.MEDIUM || 0,
            low: data.severity_summary.LOW || 0,
            unknown: data.severity_summary.UNKNOWN || 0
          };
          
          // 更新本地存储
          localStorage.setItem('vulnerabilitySettings', JSON.stringify(chartData.value));
          vulnReportGenerated.value = true; // 确保设置标志为true
          
          if (hasData.value) {
            if (!chartInstance.value) {
              initChart();
            } else {
              updateChart();
            }
          }
          return;
        }
      }
    } catch (error) {
      console.log('从后端API获取数据失败:', error);
    }
    
    // 如果无法从API获取，尝试从本地存储中获取
    const savedSettings = localStorage.getItem('vulnerabilitySettings');
    if (savedSettings) {
      const parsedSettings = JSON.parse(savedSettings);
      
      // 检查是否有值
      const hasNonZeroValues = Object.values(parsedSettings).some(val => val > 0);
      if (!hasNonZeroValues) {
        return; // 如果全是0，不更新数据
      }
      
      chartData.value = {
        critical: parsedSettings.critical || 0,
        high: parsedSettings.high || 0,
        medium: parsedSettings.medium || 0,
        low: parsedSettings.low || 0,
        unknown: parsedSettings.unknown || 0
      };
      
      // 检查是否有非零值，如果有则设置报告已生成标志
      if (Object.values(parsedSettings).some(val => val > 0)) {
        vulnReportGenerated.value = true;
        localStorage.setItem('vulnReportGenerated', 'true');
      }
      
      if (hasData.value) {
        if (!chartInstance.value) {
          initChart();
        } else {
          updateChart();
        }
      } else if (chartInstance.value) {
        // 如果没有数据但图表存在，销毁图表
        chartInstance.value.dispose();
        chartInstance.value = null;
      }
    }
  } catch (error) {
    console.error('获取漏洞数据失败:', error);
  }
};

// 监听本地存储变化
const handleStorageChange = (event) => {
  if (event.key === 'vulnerabilitySettings') {
    const savedSettings = localStorage.getItem('vulnerabilitySettings');
    if (savedSettings) {
      const parsedSettings = JSON.parse(savedSettings);
      chartData.value = {
        critical: parsedSettings.critical || 0,
        high: parsedSettings.high || 0,
        medium: parsedSettings.medium || 0,
        low: parsedSettings.low || 0,
        unknown: parsedSettings.unknown || 0
      };
      
      // 检查是否有非零值，如果有则设置报告已生成标志
      if (Object.values(parsedSettings).some(val => val > 0)) {
        vulnReportGenerated.value = true;
        localStorage.setItem('vulnReportGenerated', 'true');
      }
      
      if (hasData.value) {
        if (!chartInstance.value) {
          initChart();
        } else {
          updateChart();
        }
      } else if (chartInstance.value) {
        // 如果没有数据但图表存在，销毁图表
        chartInstance.value.dispose();
        chartInstance.value = null;
      }
    }
  } else if (event.key === 'vulnReportGenerated') {
    vulnReportGenerated.value = event.newValue === 'true';
  }
};
</script>

<style scoped>
.vulnerability-chart {
  padding: 10px;
  border: 1px solid #eaeaea;
  border-radius: 4px;
  height: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden; /* 防止整体出现滚动条 */
}

#vulnerability-chart {
  width: 100%;
  height: 300px;
  min-height: 300px;
}

.empty-state {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 300px;
  color: #999;
  font-style: italic;
  background-color: #f9f9f9;
  border-radius: 4px;
}
</style> 