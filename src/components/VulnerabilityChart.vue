<template>
  <div class="vulnerability-chart" ref="chartRef"></div>
</template>

<script setup>
import { ref, onMounted, watch, computed } from 'vue';
import * as echarts from 'echarts';

const props = defineProps({
  data: {
    type: Object,
    required: true,
    default: () => ({
      critical: 3,
      high: 5,
      medium: 8,
      low: 12,
      unknown: 2
    })
  }
});

const chartRef = ref(null);
let chart = null;

// 计算最大值，用于y轴适应
const maxValue = computed(() => {
  const values = [
    props.data.critical,
    props.data.high,
    props.data.medium,
    props.data.low,
    props.data.unknown
  ];
  const max = Math.max(...values);
  // 向上取整到最近的5的倍数，确保有足够空间
  return Math.ceil(max / 5) * 5;
});

const initChart = () => {
  if (!chartRef.value) return;
  
  chart = echarts.init(chartRef.value);
  const option = {
    title: {
      text: '漏洞分布统计',
      left: 'center'
    },
    tooltip: {
      trigger: 'item',
      formatter: function(params) {
        return `${params.name}: ${params.value}`;
      }
    },
    legend: {
      data: ['漏洞数量'],
      bottom: 0,
      show: false
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '15%',
      top: '15%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      data: ['极其严重', '高危', '中危', '低危', '未知危险性'],
      axisLabel: {
        interval: 0,
        rotate: 0
      }
    },
    yAxis: {
      type: 'value',
      minInterval: 1,
      min: 0,
      max: function() {
        return maxValue.value > 5 ? maxValue.value : 5;
      },
      axisLabel: {
        formatter: function(value) {
          return value;
        }
      },
      splitLine: {
        show: true,
        lineStyle: {
          type: 'dashed'
        }
      }
    },
    series: [
      {
        name: '漏洞数量',
        type: 'bar',
        barWidth: '40%',
        data: [
          {
            value: props.data.critical,
            itemStyle: { color: '#8B0000' } // 深红色
          },
          {
            value: props.data.high,
            itemStyle: { color: '#FF0000' } // 红色
          },
          {
            value: props.data.medium,
            itemStyle: { color: '#FFA500' } // 橙色
          },
          {
            value: props.data.low,
            itemStyle: { color: '#32CD32' } // 绿色
          },
          {
            value: props.data.unknown,
            itemStyle: { color: '#808080' } // 灰色
          }
        ]
      }
    ]
  };
  chart.setOption(option);
};

onMounted(() => {
  initChart();
  window.addEventListener('resize', () => {
    chart?.resize();
  });
});

watch(() => props.data, () => {
  if (chart) {
    chart.setOption({
      yAxis: {
        max: maxValue.value > 5 ? maxValue.value : 5
      },
      series: [
        {
          data: [
            { value: props.data.critical, itemStyle: { color: '#8B0000' } },
            { value: props.data.high, itemStyle: { color: '#FF0000' } },
            { value: props.data.medium, itemStyle: { color: '#FFA500' } },
            { value: props.data.low, itemStyle: { color: '#32CD32' } },
            { value: props.data.unknown, itemStyle: { color: '#808080' } }
          ]
        }
      ]
    });
  }
}, { deep: true });
</script>

<style scoped>
.vulnerability-chart {
  width: 100%;
  height: 100%;
}
</style> 